<template>
  <div class="p-6">
    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">é¡Œé …ç®¡ç† - {{ companyName }}</h1>
      <div class="flex items-center gap-3">
        <p class="text-gray-600 dark:text-gray-400">åƒ…é¡¯ç¤ºæ‚¨è¢«æŒ‡æ´¾çš„é¢¨éšªè©•ä¼°é¡Œé …</p>
        <div v-if="externalUserStore.userId" class="flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/20 rounded-full">
          <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z" />
          </svg>
          <span class="text-xs font-medium text-blue-600 dark:text-blue-400">å·²ç¯©é¸</span>
        </div>
      </div>
    </div>

    <!-- é»15 æ¸¬è©¦ç”¨é¡¯ç¤ºå€å¡Š - å·²éš±è— -->
    <!--
    <div v-if="token" class="mb-6 p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
      <h3 class="text-sm font-bold mb-3 text-orange-800 dark:text-orange-200">ğŸ§ª é»15 ç”¨æˆ¶IDæ˜ å°„æ¸¬è©¦</h3>

      Tokenè³‡è¨Š
      <div class="mb-3">
        <h4 class="text-xs font-semibold mb-2 text-gray-700 dark:text-gray-300">Tokenè³‡è¨Šï¼š</h4>
        <div class="bg-white dark:bg-gray-800 p-2 rounded border text-xs">
          <div class="mb-1">
            <span class="font-medium text-gray-600 dark:text-gray-400">Tokenå€¼ï¼š</span>
            <code class="text-blue-600 dark:text-blue-400">{{ token ? token.slice(0, 20) + '...' : 'ç„¡' }}</code>
          </div>
        </div>
      </div>

      åŸå§‹ç”¨æˆ¶è³‡è¨Š
      <div class="mb-3">
        <h4 class="text-xs font-semibold mb-2 text-gray-700 dark:text-gray-300">åŸå§‹ç”¨æˆ¶è³‡è¨Š (userInfo)ï¼š</h4>
        <div class="bg-white dark:bg-gray-800 p-2 rounded border text-xs">
          <div class="mb-1">
            <span class="font-medium text-gray-600 dark:text-gray-400">userInfo.data.user_idï¼š</span>
            <span class="text-gray-800 dark:text-gray-200">{{ externalUserStore.userInfo?.data?.user_id || 'null' }}</span>
          </div>
          <div class="mb-1">
            <span class="font-medium text-gray-600 dark:text-gray-400">userInfo.data.user_nameï¼š</span>
            <span class="text-gray-800 dark:text-gray-200">{{ externalUserStore.userInfo?.data?.user_name || 'null' }}</span>
          </div>
          <div class="mb-1">
            <span class="font-medium text-gray-600 dark:text-gray-400">userInfo.data.emailï¼š</span>
            <span class="text-gray-800 dark:text-gray-200">{{ externalUserStore.userInfo?.data?.email || 'null' }}</span>
          </div>
          <div class="mb-1">
            <span class="font-medium text-gray-600 dark:text-gray-400">userInfo.data.com_idï¼š</span>
            <span class="text-gray-800 dark:text-gray-200">{{ externalUserStore.userInfo?.data?.com_id || 'null' }}</span>
          </div>
        </div>
      </div>

      IDæ˜ å°„é©—è­‰
      <div class="mb-3">
        <h4 class="text-xs font-semibold mb-2 text-gray-700 dark:text-gray-300">IDæ˜ å°„é©—è­‰ï¼š</h4>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="bg-white dark:bg-gray-800 p-2 rounded border">
            <span class="font-medium text-gray-600 dark:text-gray-400">externalId (should be userInfo.data.user_id)ï¼š</span>
            <span class="text-gray-800 dark:text-gray-200">{{ externalUserStore.externalId || 'null' }}</span>
          </div>
          <div class="bg-white dark:bg-gray-800 p-2 rounded border">
            <span class="font-medium text-gray-600 dark:text-gray-400">userId (internal from API)ï¼š</span>
            <span class="text-gray-800 dark:text-gray-200">{{ externalUserStore.userId || 'null' }}</span>
          </div>
          <div class="bg-white dark:bg-gray-800 p-2 rounded border">
            <span class="font-medium text-gray-600 dark:text-gray-400">companyId (should be userInfo.user.com_id)ï¼š</span>
            <span class="text-blue-600 dark:text-blue-400 font-medium">{{ externalUserStore.companyId || 'null' }}</span>
          </div>
        </div>
      </div>

      æ˜ å°„ç‹€æ…‹æª¢æŸ¥
      <div>
        <h4 class="text-xs font-semibold mb-2 text-gray-700 dark:text-gray-300">æ˜ å°„ç‹€æ…‹æª¢æŸ¥ï¼š</h4>
        <div class="bg-white dark:bg-gray-800 p-2 rounded border text-xs">
          <div class="mb-1">
            <span class="font-medium text-gray-600 dark:text-gray-400">æ˜ å°„æ˜¯å¦æ­£ç¢ºï¼š</span>
            <span :class="mappingStatusColor">{{ mappingStatus }}</span>
          </div>
          <div v-if="mappingIssues.length > 0" class="mt-2">
            <span class="font-medium text-red-600 dark:text-red-400">ç™¼ç¾å•é¡Œï¼š</span>
            <ul class="list-disc list-inside text-red-600 dark:text-red-400 mt-1">
              <li v-for="issue in mappingIssues" :key="issue">{{ issue }}</li>
            </ul>
            <div v-if="mappingIssues.some(issue => issue.includes('å…§éƒ¨ç”¨æˆ¶ID'))" class="mt-2">
              <span class="font-medium text-blue-600 dark:text-blue-400">ğŸ”„ è‡ªå‹•ä¿®å¾©ï¼š</span>
              <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
                ç³»çµ±å°‡è‡ªå‹•èª¿ç”¨äººå“¡åŒæ­¥API ({{ `/api/v1/personnel/companies/${externalUserStore.companyId}/sync` }}) ä¾†è¼‰å…¥äººå“¡è³‡æ–™
              </p>
            </div>
          </div>
        </div>
      </div>

      ç¯©é¸åƒæ•¸æª¢æŸ¥
      <div class="mt-3">
        <h4 class="text-xs font-semibold mb-2 text-gray-700 dark:text-gray-300">ç¯©é¸åƒæ•¸æª¢æŸ¥ï¼š</h4>
        <div class="bg-white dark:bg-gray-800 p-2 rounded border text-xs">
          <div class="grid grid-cols-2 gap-2">
            <div class="mb-1">
              <span class="font-medium text-gray-600 dark:text-gray-400">ç¯©é¸ç‹€æ…‹ï¼š</span>
              <span v-if="externalUserStore.userId" class="text-green-600 dark:text-green-400 font-medium">âœ… å·²å•Ÿç”¨ä½¿ç”¨è€…ç¯©é¸</span>
              <span v-else class="text-yellow-600 dark:text-yellow-400 font-medium">âš ï¸ é¡¯ç¤ºæ‰€æœ‰è³‡æ–™</span>
            </div>
            <div class="mb-1">
              <span class="font-medium text-gray-600 dark:text-gray-400">ç¯©é¸ä¾æ“šï¼š</span>
              <span class="text-blue-600 dark:text-blue-400">personnel_id = {{ externalUserStore.userId || 'null' }}</span>
            </div>
            <div class="mb-1">
              <span class="font-medium text-gray-600 dark:text-gray-400">è¼‰å…¥ç‹€æ…‹ï¼š</span>
              <span v-if="isFilteringAssignments" class="text-blue-600 dark:text-blue-400">ğŸ”„ æ­£åœ¨ç¯©é¸ä¸­...</span>
              <span v-else class="text-green-600 dark:text-green-400">âœ… è¼‰å…¥å®Œæˆ</span>
            </div>
            <div class="mb-1">
              <span class="font-medium text-gray-600 dark:text-gray-400">çµæœæ•¸é‡ï¼š</span>
              <span class="text-purple-600 dark:text-purple-400 font-medium">{{ questionManagement.length }} å€‹è©•ä¼°é …ç›®</span>
            </div>
          </div>
          <div v-if="externalUserStore.userId" class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
            <span class="font-medium text-gray-600 dark:text-gray-400">ç¯©é¸é‚è¼¯ï¼š</span>
            <code class="text-xs text-blue-600 dark:text-blue-400 bg-gray-100 dark:bg-gray-700 px-1 rounded ml-1">
              åªé¡¯ç¤º personnel_id={{ externalUserStore.userId }} è¢«æŒ‡æ´¾çš„è©•ä¼°é …ç›®
            </code>
          </div>
        </div>
      </div>
    </div>
    -->

    <!-- External User Info Display - Hidden per request -->
    <!--
    <div v-if="externalUserStore.hasUserInfo" class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-green-800 dark:text-green-200">
            å¤–éƒ¨ç”¨æˆ¶å·²ç™»å…¥
          </h3>
          <div class="mt-2 text-sm text-green-700 dark:text-green-300">
            <p><strong>ç”¨æˆ¶åç¨±:</strong> {{ externalUserStore.userName }}</p>
            <p v-if="externalUserStore.externalId"><strong>å¤–éƒ¨ID:</strong> {{ externalUserStore.externalId }}</p>
            <p v-if="externalUserStore.userId"><strong>å…§éƒ¨ID:</strong> {{ externalUserStore.userId }}</p>
            <p v-if="externalUserStore.userEmail"><strong>é›»å­éƒµä»¶:</strong> {{ externalUserStore.userEmail }}</p>
            <p class="text-xs mt-1 text-green-600 dark:text-green-400">
              è³‡æ–™å·²å„²å­˜è‡³ SessionStorageï¼Œæœ€å¾Œæ›´æ–°: {{ new Date(externalUserStore.lastUpdated).toLocaleString() }}
            </p>
          </div>
        </div>
      </div>
    </div>


    <div v-else-if="token && !externalUserStore.isLoaded" class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
      <div class="flex items-center">
        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
        <span class="text-sm text-blue-800 dark:text-blue-200">æ­£åœ¨è¼‰å…¥å¤–éƒ¨ç”¨æˆ¶è³‡è¨Š...</span>
      </div>
    </div>


    <div v-else-if="!token" class="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
            æœªæä¾› Token
          </h3>
          <div class="mt-2 text-sm text-yellow-700 dark:text-yellow-300">
            <p>URL ä¸­æœªåŒ…å« token åƒæ•¸ï¼Œç„¡æ³•è¼‰å…¥å¤–éƒ¨ç”¨æˆ¶è³‡è¨Š</p>
          </div>
        </div>
      </div>
    </div>
    -->


    <!-- Company Warning Message -->
    <div v-if="showCompanyWarning" class="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
            å…¬å¸ä¸å­˜åœ¨
          </h3>
          <div class="mt-2 text-sm text-yellow-700 dark:text-yellow-300">
            <p>æ‰¾ä¸åˆ° ID ç‚º "{{ companyId }}" çš„å…¬å¸ã€‚é€™å¯èƒ½æ˜¯å› ç‚ºï¼š</p>
            <ul class="mt-1 ml-4 list-disc">
              <li>å…¬å¸è³‡æ–™å·²è¢«åˆªé™¤</li>
              <li>URL ä¸­çš„å…¬å¸ ID ä¸æ­£ç¢º</li>
              <li>ç³»çµ±è³‡æ–™éœ€è¦æ›´æ–°</li>
            </ul>
            <p class="mt-2">
              è«‹æª¢æŸ¥ URL æˆ–è¯ç¹«ç³»çµ±ç®¡ç†å“¡ã€‚
              <nuxt-link to="/web/risk-assessment/questions" class="font-medium underline hover:no-underline">
                è¿”å›å…¬å¸åˆ—è¡¨
              </nuxt-link>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State for Assignment Filtering -->
    <div v-if="isFilteringAssignments" class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
      <div class="flex items-center">
        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
        <span class="text-sm text-blue-800 dark:text-blue-200">æ­£åœ¨ç¯©é¸æ‚¨è¢«æŒ‡æ´¾çš„é¡Œé …...</span>
      </div>
    </div>

    <!-- Data Table -->
    <DataTable
      :data="questionManagement"
      :columns="columns"
      search-placeholder="æœå°‹é¡Œé …åç¨±ã€å¹´ä»½æˆ–ç¯„æœ¬ç‰ˆæœ¬..."
      :search-fields="['name', 'year', 'templateVersion']"
      empty-title="æ²’æœ‰è¢«æŒ‡æ´¾çš„é¡Œé …"
      empty-message="æ‚¨ç›®å‰æ²’æœ‰è¢«æŒ‡æ´¾åˆ°ä»»ä½•é¢¨éšªè©•ä¼°é¡Œé …"
      no-search-results-title="æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„é …ç›®"
      no-search-results-message="è«‹å˜—è©¦å…¶ä»–æœå°‹é—œéµå­—"
      @search="(query) => console.log('æœå°‹æŸ¥è©¢:', query)"
      @sort="(field, order) => console.log('æ’åº:', field, order)"
    >
      <!-- Actions Slot for Web Version -->
      <template #actions>
        <div class="flex gap-2">
          <button
            @click="loadQuestionManagementData"
            :disabled="isFilteringAssignments"
            class="flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
          >
            <ArrowPathIcon
              class="w-4 h-4 mr-2"
              :class="{ 'animate-spin': isFilteringAssignments }"
            />
            é‡æ–°æ•´ç†
          </button>
        </div>
      </template>

      <!-- Custom Actions Cell - Web Version (Simplified) -->
      <template #cell-actions="{ item }">
        <div class="flex items-center space-x-2 justify-center">
          <!-- Fill Assessment Form -->
          <div class="relative group">
            <button
              @click="showAssessmentForm(item)"
              class="p-2 text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors duration-200"
            >
              <DocumentTextIcon class="w-4 h-4" />
            </button>
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-900 dark:bg-gray-700 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10">
              å¡«å¯«è©•ä¼°è¡¨
              <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900 dark:border-t-gray-700"></div>
            </div>
          </div>

          <!-- View Statistics -->
          <div class="relative group">
            <button
              @click="showStatistics(item)"
              class="p-2 text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-lg transition-colors duration-200"
            >
              <ChartBarIcon class="w-4 h-4" />
            </button>
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-900 dark:bg-gray-700 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10">
              æª¢è¦–è©•ä¼°è¡¨çµ±è¨ˆçµæœ
              <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900 dark:border-t-gray-700"></div>
            </div>
          </div>
        </div>
      </template>

      <!-- Empty Action Slot - Web Version -->
      <template #emptyAction>
        <div class="text-center text-gray-500 dark:text-gray-400">
          <p class="text-sm">è«‹è¯ç¹«ç®¡ç†å“¡ç‚ºæ‚¨æŒ‡æ´¾è©•ä¼°é¡Œé …</p>
        </div>
      </template>
    </DataTable>
  </div>
</template>

<script setup>
definePageMeta({
  middleware: 'auth'
})

import {
  DocumentTextIcon,
  ChartBarIcon,
  ArrowPathIcon
} from '@heroicons/vue/24/outline'

const route = useRoute()
const companyId = computed(() => route.params.id)

// ç²å– URL ä¸­çš„ token åƒæ•¸
const token = computed(() => route.query.token)

// ä½¿ç”¨å¤–éƒ¨ç”¨æˆ¶ store
const externalUserStore = useExternalUserStore()

// Web version: Simplified - only need for display
const templatesStore = useTemplatesStore()
const availableTemplates = computed(() => templatesStore?.templates || [])

// Get company data from local database API (same as admin version)
const { getCompanyNameById, loading: companiesLoading, error: companiesError } = useLocalCompanies()

// Store company name in reactive ref for async loading
const companyName = ref('è¼‰å…¥ä¸­...')
const companyExists = ref(true)

// Load company name asynchronously
const loadCompanyName = async () => {
  if (!companyId.value) {
    companyName.value = 'æœªçŸ¥å…¬å¸'
    companyExists.value = false
    return
  }

  try {
    const name = await getCompanyNameById(companyId.value)
    if (name) {
      companyName.value = name
      companyExists.value = true
    } else {
      companyName.value = `å…¬å¸ #${companyId.value}`
      companyExists.value = false
    }
  } catch (error) {
    console.error('Error loading company name:', error)
    companyName.value = `å…¬å¸ #${companyId.value}`
    companyExists.value = false
  }
}

// Show warning message for non-existent companies
const showCompanyWarning = computed(() => {
  return !companiesLoading.value && !companiesError.value && !companyExists.value
})

// æ˜ å°„ç‹€æ…‹æª¢æŸ¥è¨ˆç®—å±¬æ€§
const mappingStatus = computed(() => {
  const userDataUserId = externalUserStore.userInfo?.data?.user_id
  const storeExternalId = externalUserStore.externalId

  if (!userDataUserId) {
    return 'ç„¡ç”¨æˆ¶è³‡æ–™'
  } else if (userDataUserId.toString() === storeExternalId?.toString()) {
    return 'âœ“ æ­£ç¢ºæ˜ å°„'
  } else {
    return 'âœ— æ˜ å°„éŒ¯èª¤'
  }
})

const mappingStatusColor = computed(() => {
  const status = mappingStatus.value
  if (status === 'âœ“ æ­£ç¢ºæ˜ å°„') {
    return 'text-green-600 dark:text-green-400 font-medium'
  } else if (status === 'âœ— æ˜ å°„éŒ¯èª¤') {
    return 'text-red-600 dark:text-red-400 font-medium'
  } else {
    return 'text-yellow-600 dark:text-yellow-400 font-medium'
  }
})

const mappingIssues = computed(() => {
  const issues = []
  const userDataUserId = externalUserStore.userInfo?.data?.user_id
  const storeExternalId = externalUserStore.externalId
  const storeUserId = externalUserStore.userId

  if (!userDataUserId) {
    issues.push('ç¼ºå°‘ userInfo.data.user_id è³‡æ–™')
  }

  if (userDataUserId && !storeExternalId) {
    issues.push('externalId æœªæ­£ç¢ºè¨­å®š')
  }

  if (userDataUserId && storeExternalId && userDataUserId.toString() !== storeExternalId.toString()) {
    issues.push(`IDä¸åŒ¹é…ï¼šuserInfo.data.user_id(${userDataUserId}) â‰  externalId(${storeExternalId})`)
  }

  if (storeExternalId && storeUserId === null) {
    issues.push('å…§éƒ¨ç”¨æˆ¶ID (userId) å°šæœªé€šéAPIæŸ¥è©¢ç²å¾—')
  }

  return issues
})

// Set page title
const pageTitle = computed(() => `é¡Œé …ç®¡ç† - ${companyName.value || 'å…¬å¸'}`)
usePageTitle(pageTitle)

// Question management composable
const {
  getQuestionManagementByCompany,
  initializeCompanyQuestionManagement
} = useQuestionManagement()

// Reactive data for question management items
const questionManagement = ref([])
const isFilteringAssignments = ref(false)

// Load question management data filtered by current user assignments
const loadQuestionManagementData = async () => {
  try {
    isFilteringAssignments.value = true

    console.log('=== Webç‰ˆæœ¬é é¢è³‡æ–™è¼‰å…¥ ===')
    console.log('Company ID:', companyId.value)
    console.log('Company Name:', companyName.value)
    console.log('Current User ID:', externalUserStore.userId)

    // Use the updated getter with userId parameter for automatic filtering
    const filteredData = await getQuestionManagementByCompany(companyId.value, externalUserStore.userId)

    questionManagement.value = filteredData

    console.log('=== Getterçµæœ ===')
    console.log(`éæ¿¾å¾Œè©•ä¼°æ•¸é‡: ${filteredData.length}`)
    console.log('Filtered Assessments:', filteredData.map(a => ({ id: a.id, year: a.year })))
    console.log('=== è³‡æ–™çµæŸ ===')

  } catch (error) {
    console.error('Error loading question management data:', error)
    questionManagement.value = []
  } finally {
    isFilteringAssignments.value = false
  }
}

// Initialize question management for this company
onMounted(async () => {
  // å„ªå…ˆèª¿ç”¨ç”¨æˆ¶è³‡æ–™è§£å¯† API ä¸¦å„²å­˜åˆ° Pinia Store
  if (token.value) {
    await externalUserStore.fetchExternalUserData(token.value)
  }

  // Load company name first
  await loadCompanyName()

  await initializeCompanyQuestionManagement(companyId.value, externalUserStore.userId)
  await loadQuestionManagementData()

  // Initialize templates store to fetch templates from database
  try {
    await templatesStore.initialize()
    console.log('Templates loaded from database:', templatesStore.templates.length)
  } catch (error) {
    console.error('Failed to load templates from database:', error)
  }

  console.log('=== Webç‰ˆæœ¬é é¢è¼‰å…¥å®Œæˆ ===')
  console.log('Route Params:', route.params)
  console.log('Route Query (Token):', route.query)
  console.log('Company ID from Route:', companyId.value)
  console.log('Company Name:', companyName.value)
  console.log('Available Templates on Mount:', availableTemplates.value)
  console.log('å¤–éƒ¨ç”¨æˆ¶è³‡è¨Š:', externalUserStore.userInfo)
  console.log('å¤–éƒ¨ç”¨æˆ¶åç¨±:', externalUserStore.userName)
  console.log('å¤–éƒ¨ç”¨æˆ¶ID:', externalUserStore.userId)
  console.log('å¤–éƒ¨ç”¨æˆ¶Email:', externalUserStore.userEmail)
  console.log('å¤–éƒ¨ç”¨æˆ¶å…¬å¸ID (companyId):', externalUserStore.companyId)

  console.log('=== ç¯©é¸åƒæ•¸æª¢æŸ¥ ===')
  console.log('ç¯©é¸ç‹€æ…‹:', externalUserStore.userId ? 'âœ… å·²å•Ÿç”¨ä½¿ç”¨è€…ç¯©é¸' : 'âš ï¸ é¡¯ç¤ºæ‰€æœ‰è³‡æ–™')
  console.log('ç¯©é¸ä¾æ“š: personnel_id =', externalUserStore.userId || 'null')
  console.log('æœ€çµ‚é¡¯ç¤ºé …ç›®æ•¸é‡:', questionManagement.value.length)
  console.log('=== åˆå§‹è³‡æ–™çµæŸ ===')
})

// Watch for changes in company ID (route parameter changes)
watch(companyId, async (newId, oldId) => {
  if (newId !== oldId && newId) {
    console.log('=== Webç‰ˆæœ¬ï¼šå…¬å¸ ID è®Šæ›´ ===')
    console.log('èˆŠ ID:', oldId)
    console.log('æ–° ID:', newId)
    await loadQuestionManagementData()
    console.log('=== å…¬å¸è³‡æ–™é‡æ–°è¼‰å…¥å®Œæˆ ===')
  }
})

// DataTable columns configuration
const columns = ref([
  {
    key: 'actions',
    label: 'åŠŸèƒ½',
    sortable: false,
    cellClass: 'text-base text-gray-900 dark:text-white'
  },
  {
    key: 'name',
    label: 'é¡Œé …åç¨±',
    sortable: true,
    cellClass: 'text-base text-gray-900 dark:text-white'
  },
  {
    key: 'year',
    label: 'å¹´ä»½',
    sortable: true,
    cellClass: 'text-base font-medium text-gray-900 dark:text-white'
  },
  {
    key: 'createdAt',
    label: 'å»ºç«‹æ—¥æœŸ',
    sortable: true,
    cellClass: 'text-base text-gray-900 dark:text-white'
  }
])

// Web version: Navigate to content page (same as admin) to show assigned questions
const showAssessmentForm = (item) => {
  console.log('=== å°èˆªåˆ°å…§å®¹é é¢ ===')
  console.log('Navigating to content page for:', item)
  console.log('Company ID:', companyId.value)
  console.log('Question ID (item.id):', item.id)

  // æ ¹æ“šé»13è¦æ±‚ï¼šå°èˆªåˆ°å…§å®¹é é¢ï¼Œèˆ‡ admin ç‰ˆæœ¬ç›¸åŒï¼Œåˆ—å‡ºè¢«æŒ‡æ´¾çš„é¡Œç›®
  // å°èˆªåˆ° [companyId]/management/[questionId]/content.vue è·¯ç”±
  const targetUrl = `/web/risk-assessment/questions/${companyId.value}/management/${item.id}/content`
  console.log('Target URL:', targetUrl)
  console.log('è·¯ç”±èªªæ˜: å°èˆªåˆ°å…§å®¹é é¢ï¼Œåˆ—å‡ºè¢«æŒ‡æ´¾çš„é¡Œç›® ([companyId]/management/[questionId]/content.vue)')

  // Navigate to the content page to show assigned questions (same as admin)
  // Use item.id as questionId
  navigateTo(targetUrl)
}

const showStatistics = (item) => {
  // TODO: Implement statistics modal
  console.log('Show statistics for:', item)
}
</script>